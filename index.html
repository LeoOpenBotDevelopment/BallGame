<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Joystick</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            touch-action: none; /* Prevent default touch actions */
        }

        .player {
            position: absolute;
            height: 10vw; /* Responsive size */
            width: 10vw; /* Responsive size */
            border-radius: 50%;
            background: red;
            transition: box-shadow 0.5s ease;
        }

        .player.self {
            background: cyan;
            box-shadow: 0 0 10px cyan;
        }

        #joystick-container {
            position: fixed;
            bottom: 5vh; /* Adjust for better positioning */
            left: 5vw;
            width: 20vw; /* Responsive joystick size */
            height: 20vw; /* Responsive joystick size */
            border: 1px solid #ccc;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            z-index: 100;
        }

        #joystick {
            width: 10vw; /* Responsive joystick knob size */
            height: 10vw; /* Responsive joystick knob size */
            background: #ccc;
            border-radius: 50%;
            position: absolute;
            transition: transform 0.2s ease-out;
        }

        .dot-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-size: 15px 15px;
            background-image: radial-gradient(#f0f0f0 1px, transparent 1px);
            z-index: -1;
        }
    </style>
</head>
<body>
    <div class="dot-grid"></div>
    <div id="joystick-container">
        <div id="joystick"></div>
    </div>

    <script>
        // Player data
        let playerId = "player" + Math.random().toString(36).substring(7);
        const players = {};
        const playerElement = document.createElement('div');
        playerElement.classList.add('player', 'self');
        document.body.appendChild(playerElement);

        const joystickContainer = document.getElementById('joystick-container');
        const joystick = document.getElementById('joystick');
        const containerRect = joystickContainer.getBoundingClientRect();
        const containerRadius = containerRect.width / 2;
        const joystickRadius = joystick.offsetWidth / 2;
        const maxDistance = containerRadius - joystickRadius;

        let isDragging = false;
        let velocityX = 0;
        let velocityY = 0;
        const playerSpeed = 5;
        let playerPosition = { x: 50, y: 50 };
        const heartbeatInterval = 5000;
        const playerTimeout = 10000;
        const playersTimeout = {};

        const channel = new BroadcastChannel('game_channel');

        // Function to move joystick
        function moveJoystick(clientX, clientY) {
            const containerCenterX = containerRect.left + containerRadius;
            const containerCenterY = containerRect.top + containerRadius;
            const deltaX = clientX - containerCenterX;
            const deltaY = clientY - containerCenterY;
            const distance = Math.sqrt(deltaX ** 2 + deltaY ** 2);
            const angle = Math.atan2(deltaY, deltaX);

            const limitedDistance = Math.min(distance, maxDistance);
            const newX = Math.cos(angle) * limitedDistance;
            const newY = Math.sin(angle) * limitedDistance;

            joystick.style.transform = `translate(${newX}px, ${newY}px)`;

            velocityX = newX / maxDistance * playerSpeed;
            velocityY = newY / maxDistance * playerSpeed;
        }

        function resetJoystick() {
            joystick.style.transform = `translate(0, 0)`;
            velocityX = 0;
            velocityY = 0;
            playerElement.style.boxShadow = `0 0 10px rgba(0, 0, 0, 0)`;
        }

        function updatePlayerPosition(position) {
            playerPosition.x += velocityX;
            playerPosition.y += velocityY;
            playerElement.style.transform = `translate(${playerPosition.x}vw, ${playerPosition.y}vh)`;
            channel.postMessage({ playerId, position: playerPosition });
        }

        function handleHeartbeat(playerId) {
            if (playersTimeout[playerId]) {
                clearTimeout(playersTimeout[playerId]);
            }

            if (!players[playerId]) {
                const newPlayerElement = document.createElement('div');
                newPlayerElement.classList.add('player');
                document.body.appendChild(newPlayerElement);
                players[playerId] = { element: newPlayerElement, lastPosition: { x: 0, y: 0 } };
            }

            playersTimeout[playerId] = setTimeout(() => {
                const playerElement = players[playerId].element;
                if (playerElement) {
                    playerElement.remove();
                    delete players[playerId];
                    delete playersTimeout[playerId];
                }
            }, playerTimeout);
        }

        channel.addEventListener('message', (event) => {
            const { playerId, position } = event.data;
            handleHeartbeat(playerId);
            const playerData = players[playerId];

            if (position.x !== playerData.lastPosition.x || position.y !== playerData.lastPosition.y) {
                playerData.element.style.transform = `translate(${position.x}vw, ${position.y}vh)`;
                playerData.element.style.boxShadow = `0 0 10px red`;
                playerData.lastPosition = { x: position.x, y: position.y };
            } else {
                playerData.element.style.boxShadow = `0 0 10px rgba(0, 0, 0, 0)`;
            }
        });

        setInterval(() => {
            channel.postMessage({ playerId, position: playerPosition });
        }, heartbeatInterval);

        joystick.addEventListener('mousedown', (event) => {
            isDragging = true;
            event.preventDefault();
        });

        joystick.addEventListener('touchstart', (event) => {
            isDragging = true;
        });

        document.addEventListener('mousemove', (event) => {
            if (isDragging) {
                moveJoystick(event.clientX, event.clientY);
                playerElement.style.boxShadow = `0 0 10px cyan`;
            }
        });

        document.addEventListener('touchmove', (event) => {
            if (isDragging) {
                const touch = event.touches[0];
                moveJoystick(touch.clientX, touch.clientY);
                playerElement.style.boxShadow = `0 0 10px cyan`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                resetJoystick();
                playerElement.style.boxShadow = `0 0 10px rgba(0, 0, 0, 0)`;
            }
        });

        document.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                resetJoystick();
                playerElement.style.boxShadow = `0 0 10px rgba(0, 0, 0, 0)`;
            }
        });

        function gameLoop() {
            updatePlayerPosition(playerPosition);
            requestAnimationFrame(gameLoop);
        }

        gameLoop(); // Start game loop
    </script>
</body>
</html>
